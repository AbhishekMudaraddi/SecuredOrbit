name: Test Pipeline

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - develop
      - test

jobs:
  test:
    runs-on: ubuntu-latest
    
    env:
      # Set test environment variables so app can import
      SECRET_KEY: 'test-secret-key-for-ci-cd-pipeline-only'
      AWS_REGION: 'us-east-1'
      DYNAMODB_USERS_TABLE: 'PasswordManagerV2-Users-Test'
      DYNAMODB_PASSWORDS_TABLE: 'PasswordManagerV2-Passwords-Test'
      FLASK_DEBUG: 'false'
      PORT: '5000'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov flake8 black
    
    - name: Lint with flake8
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      continue-on-error: true
    
    - name: Check code formatting
      run: |
        black --check .
      continue-on-error: true
    
    - name: Run tests
      run: |
        pytest tests/ -v --cov=app --cov-report=xml || echo "No tests found"
      continue-on-error: true
    
    - name: Check Python syntax
      run: |
        python -m py_compile app.py
    
    - name: Validate requirements
      run: |
        pip check
    
    - name: Test imports
      run: |
        python -c "import app; print('âœ“ All imports successful')"